
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batkaro</title>
    
    <!-- Step 1: RAZORPAY SCRIPT (Payment ke liye zaroori hai) -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Original Styles and Fonts -->
    <style>
        /* --- üåë GLOBAL THEME & STYLE (DEFAULT/LIGHT MODE) --- */
        
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            --primary-pink: #E91E63;
            --accent-cyan: #00BCD4;
            --primary-blue: #4A90E2;
            --light-bg: #F4F6F8; /* Light gray background */
            --content-bg: #FFFFFF; /* White for cards and elements */
            --text-color: #212121; /* Dark gray for text */
            --text-muted: #666666; /* Muted text color */
            --muted-pink: rgba(233, 30, 99, 0.8);
            --shadow-color: rgba(100, 100, 111, 0.2);
            --sent-bubble-bg: #e1ffc7; /* Light green for sent messages */
            --online-indicator: #4CAF50; /* Green for online status */
            --danger-red: #f44336;
            --seen-blue: #34B7F1; /* Blue color for seen ticks */
            /* NEW: Colors for Gold and Silver Coins */
            --gold-coin: #FFD700;
            --silver-coin: #C0C0C0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        /* MODIFIED: Body styles for better desktop viewing */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
            overflow-x: hidden; /* Prevent horizontal scroll */
            font-synthesis: none;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: flex;
            justify-content: center;
            background-color: #e5e5e5; /* A neutral background for desktop */
        }
        
        /* NEW: Main container for mobile view on desktop */
        #app-container {
            width: 100%;
            max-width: 500px; /* Max width for the app frame */
            min-height: 100vh;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            background-color: var(--light-bg);
            overflow: hidden; /* Hide overflow within the app frame */
        }
        
        /* MODIFIED: Page styles to allow content to grow */
        .page {
            display: none;
            min-height: 100vh; /* Changed from height to min-height */
            width: 100%;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            background-color: var(--light-bg);
        }
        
        .page.active {
            display: flex;
            opacity: 1;
        }
        
        .hidden {
            display: none !important;
        }

        /* --- ‚ú® NEW: AUTHENTICATION SCREEN --- */
        #auth-screen {
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #fce4ec, #e3f2fd);
            overflow-y: auto;
        }
        .auth-container {
            width: 100%;
            max-width: 400px;
            background: var(--content-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 30px var(--shadow-color);
        }
        .auth-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-pink);
            font-weight: 700;
        }
        .auth-form .input-group {
            margin-bottom: 15px;
        }
        .auth-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .auth-form input, .auth-form select, .auth-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
        }
        .auth-form button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 25px;
            background-color: var(--primary-pink);
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        .auth-form button:hover {
            background-color: #d81b60;
        }
        .auth-form button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .auth-toggle-link {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        .auth-toggle-link span {
            color: var(--primary-blue);
            cursor: pointer;
            font-weight: 500;
        }
        
        /* NEW: Styles for Image Upload in Signup Form */
        .image-upload-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }
        #image-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #eee;
            object-fit: cover;
            display: none; /* Initially hidden */
        }
        #signup-image-label {
            background-color: var(--primary-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        #signup-image {
            display: none; /* Hide the actual file input */
        }
        #upload-status {
            font-size: 0.8rem;
            color: var(--text-muted);
            height: 1.2em;
        }


        /* --- üè† PAGE 2 ‚Äî HOME SCREEN (Connecto Style) --- */
        #home-screen .page-header {
            background: var(--content-bg);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }
        .app-logo-home { font-size: 1.5rem; font-weight: 700; color: var(--primary-pink); }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        
        /* MODIFIED: Balance display for two coin types */
        .balance-container {
            display: flex;
            gap: 8px;
            align-items: center;
            background: #f0f0f0;
            padding: 5px 10px;
            border-radius: 20px;
        }
        .balance-display {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .balance-display .coin-icon { width: 18px; height: 18px; }
        .balance-separator {
            width: 1px;
            height: 16px;
            background-color: #ccc;
        }

        .header-profile-icon img { width: 32px; height: 32px; border-radius: 50%; }

        .home-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px 15px 90px 15px; /* Added padding-bottom for nav bar */
        }
        
        .random-call-card {
            background: linear-gradient(135deg, #e3f2fd, #e8eaf6);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .random-call-card .text h3 { font-size: 1rem; margin-bottom: 2px; }
        .random-call-card .text p { font-size: 0.8rem; color: var(--text-muted); }
        .random-call-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
        }

        .category-bar-container {
            padding: 0 0 15px 0;
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .category-bar-container::-webkit-scrollbar { display: none; }
        .category-item {
             display: inline-block;
             color: var(--text-muted);
             padding: 6px 18px;
             margin-right: 8px;
             border-radius: 20px;
             font-size: 0.9rem;
             font-weight: 500;
             cursor: pointer;
             border: 1px solid #ddd;
             transition: all 0.3s ease;
        }
        .category-item.active {
            background-color: var(--primary-pink);
            color: white;
            border-color: var(--primary-pink);
        }

        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .profile-card.offline {
            opacity: 0.6;
            filter: grayscale(80%);
        }
        
        .profile-card.offline .online-dot {
            background-color: #9E9E9E; /* Grey dot for offline */
        }


        .profile-card {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow-color);
            aspect-ratio: 9 / 16;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .profile-card-img {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        .profile-card .online-dot {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 14px;
            height: 14px;
            background-color: var(--online-indicator);
            border-radius: 50%;
            border: 2px solid white;
            z-index: 3;
        }

        .profile-card-overlay {
            position: relative;
            z-index: 2;
            padding: 12px;
            color: white;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
        }

        .profile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 5px;
        }

        .profile-card .profile-name {
            font-weight: 600;
            font-size: 1rem;
            line-height: 1.2;
        }
        
        .profile-card .rating {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .profile-card .rating svg {
            width: 14px; height: 14px;
            fill: #fbc02d;
            margin-right: 4px;
        }

        .profile-card-tags {
            font-size: 0.75rem;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .profile-card-footer {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .profile-card .rate {
            font-size: 0.8rem;
            font-weight: 500;
            color: #ddd;
            margin-bottom: 2px;
        }
        
        /* MODIFIED: 3 Icon Layout */
        .card-actions {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px);
            padding: 5px;
            border-radius: 20px;
        }
        
        .card-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }
         .card-action-btn:active {
             transform: scale(0.9);
         }
        
        /* Specific Colors for New Actions */
        .card-action-btn.chat-btn { background-color: var(--accent-cyan); }
        .card-action-btn.voice-btn { background-color: var(--online-indicator); }
        .card-action-btn.video-btn { background-color: var(--primary-pink); }
        
        .card-action-btn svg { width: 16px; height: 16px; fill: white; }


        /* --- üë§ PAGE 3 ‚Äî PROFILE SCREEN --- */
        #profile-screen { justify-content: flex-start; overflow-y: auto; }
        .profile-header {
            background-color: var(--content-bg);
            padding: 30px 20px;
            display: flex; flex-direction: column; align-items: center;
            width: 100%; box-shadow: 0 4px 10px var(--shadow-color);
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
        }
        .profile-picture-container { position: relative; width: 120px; height: 120px; }
        .profile-picture { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary-pink); }
        .upload-icon { position: absolute; bottom: 5px; right: 5px; background-color: var(--accent-cyan); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; }
        .upload-icon svg { width: 16px; height: 16px; fill: white; }
        .profile-actions { display: flex; gap: 15px; margin-top: 20px; }
        .profile-action-btn { padding: 10px 20px; font-size: 0.9rem; font-weight: 600; color: white; border: none; border-radius: 25px; cursor: pointer; transition: all 0.2s ease; }
        .edit-profile-btn { background-color: var(--primary-pink); box-shadow: 0 4px 0 #b9184f; }
        .add-balance-btn { background-color: var(--accent-cyan); box-shadow: 0 4px 0 #008a9a; }
        .profile-action-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }
        .settings-list { list-style: none; padding: 20px 20px 90px 20px; width: 100%; }
        .settings-item { display: flex; align-items: center; background-color: var(--content-bg); padding: 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; box-shadow: 0 2px 8px var(--shadow-color); transition: transform 0.2s ease; }
        .settings-item:active { transform: scale(0.98); }
        .settings-item span { flex-grow: 1; font-weight: 500; }
        .settings-item .chevron { width: 18px; height: 18px; color: #ccc; }
        #logout-btn { background-color: var(--danger-red) !important; color: white; justify-content: center; font-weight: 600;}


        /* --- üí¨ CHAT PAGES --- */
        .app-header { display: flex; align-items: center; padding: 10px 15px; background-color: var(--content-bg); box-shadow: 0 2px 4px var(--shadow-color); flex-shrink: 0; z-index: 5; }
        .back-button { background: none; border: none; cursor: pointer; margin-right: 10px; padding: 5px; }
        .back-button svg { width: 24px; height: 24px; color: var(--text-color); }

        /* Chat List Screen */
        #chat-list-screen, #recent-screen { overflow-y: auto; }
        .app-header h1 { font-size: 1.2rem; }
        .chat-list { list-style: none; padding-bottom: 90px; }
        .chat-list-item { display: flex; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #eee; background-color: var(--content-bg); }
        .chat-list-item:hover { background-color: var(--light-bg); }
        .chat-list-item img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; }
        .chat-info { flex-grow: 1; }
        .chat-info-header { display: flex; justify-content: space-between; align-items: center; }
        .chat-name { font-weight: 600; }
        .chat-timestamp { font-size: 0.75rem; color: var(--text-muted); }
        .last-message { font-size: 0.9rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .empty-list-placeholder { text-align: center; padding: 40px 20px; color: var(--text-muted); }

        /* MODIFIED: Chat Conversation Screen (WhatsApp Style) */
        #chat-conversation-screen { background-color: #e5ddd5; }
        .chat-header-info { display: flex; align-items: center; }
        .chat-header-info img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .chat-header-info .details { display: flex; flex-direction: column; }
        .chat-header-info .details .name { font-weight: 600; font-size: 1rem; }
        .chat-header-info .details .status { font-size: 0.8rem; color: var(--text-muted); }
        
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .message-bubble { position: relative; max-width: 75%; padding: 8px 12px; border-radius: 10px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; display: flex; flex-direction: column; }
        .message-bubble.sent { background-color: var(--sent-bubble-bg); align-self: flex-end; border-bottom-right-radius: 2px; }
        .message-bubble.received { background-color: var(--content-bg); align-self: flex-start; border-bottom-left-radius: 2px; }
        .delete-btn { position: absolute; top: -8px; right: -8px; width: 20px; height: 20px; background: #ff4d4d; color: white; border: none; border-radius: 50%; font-size: 12px; line-height: 20px; text-align: center; cursor: pointer; display: none; }
        .message-bubble:hover .delete-btn { display: block; }
        
        /* NEW: Styles for message metadata (time and ticks) */
        .message-content {
            margin-bottom: 2px;
            margin-right: 10px; /* Space for metadata */
        }
        .message-meta {
            align-self: flex-end;
            display: flex;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-muted);
            opacity: 0.8;
        }
        .message-meta .timestamp {
            margin-right: 5px;
        }
        .message-meta .ticks {
            font-weight: bold;
            font-size: 1rem;
            line-height: 1;
        }
        /* MODIFIED: Changed seen tick color from pink to blue */
        .message-meta .ticks.seen {
             color: var(--seen-blue);
        }

        .chat-input-area { display: flex; padding: 10px; background-color: var(--light-bg); border-top: 1px solid #ddd; }
        .chat-input-area input { flex-grow: 1; border: none; padding: 12px; border-radius: 25px; background-color: var(--content-bg); }
        .chat-input-area input:focus { outline: none; }
        .send-btn { background: var(--primary-pink); border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; margin-left: 10px; cursor: pointer; flex-shrink: 0; }
        .send-btn svg { width: 24px; height: 24px; fill: white; }

        /* --- üîª BOTTOM NAVIGATION BAR (USER) --- */
        .bottom-nav {
            position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
            width: calc(100% - 30px); max-width: 500px; display: flex; justify-content: space-around;
            align-items: center; background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 10px 0; border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); border: 1px solid #eee; z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: #9E9E9E; transition: color 0.3s ease; }
        .nav-item.active { color: var(--primary-pink); }
        .nav-item:hover { color: var(--primary-pink); }
        .nav-item svg { width: 26px; height: 26px; stroke-width: 2; fill: none; stroke: currentColor; transition: transform 0.3s ease; }
        .nav-item:active svg { transform: scale(0.9); }

        /* --- üìû NEW: CALLING INTERFACE STYLES --- */
        #call-screen {
            background-color: #2c3e50;
            color: white;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #localVideo {
            width: 100px;
            height: 150px;
            object-fit: cover;
            position: absolute;
            bottom: 120px;
            right: 20px;
            border-radius: 10px;
            border: 2px solid white;
            z-index: 2;
            background-color: #000;
            /* CHANGE: Added transform to mirror the local video (selfie view) */
            transform: scaleX(-1);
        }

        .call-controls {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }

        .call-btn-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        .call-btn-circle:active { transform: scale(0.9); }
        .call-btn-circle svg { width: 30px; height: 30px; fill: white; }
        .btn-hangup { background-color: #f44336; }
        /* CHANGE: Consolidated background style for mic and switch camera buttons */
        .btn-mic, .btn-switch-camera { background-color: rgba(255,255,255,0.2); backdrop-filter: blur(5px); }

        /* Incoming Call Modal */
        #incoming-call-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }
        #incoming-call-modal.active { display: flex; }
        .caller-img-large { width: 100px; height: 100px; border-radius: 50%; border: 3px solid white; margin-bottom: 20px; animation: pulse 2s infinite; }
        .caller-name-display { font-size: 1.5rem; font-weight: 700; margin-bottom: 40px; }
        .incoming-actions { display: flex; gap: 40px; }
        .btn-accept { background-color: #4CAF50; animation: bounce 1s infinite; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* --- üíé MODIFIED: RECHARGE STORE PAGE STYLES --- */
        #recharge-screen {
            background-color: #f0f2f5;
            justify-content: flex-start;
        }

        .store-content {
            padding: 20px 15px 90px 15px; /* Padding for nav bar */
            width: 100%;
            overflow-y: auto;
        }
        
        .store-section {
            margin-bottom: 30px;
        }

        .store-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .store-section-header {
            margin-bottom: 20px;
            padding-left: 5px;
        }
        .store-section-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .store-section-header .coin-icon {
            width: 24px;
            height: 24px;
        }
        .store-section-header p {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .recharge-plans-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .recharge-plan {
            background-color: var(--content-bg);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .recharge-plan:hover, .recharge-plan.best-value {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(233, 30, 99, 0.15);
            border-color: var(--primary-pink);
        }
        
        .plan-tag {
            position: absolute;
            top: 10px;
            right: -30px;
            background-color: var(--primary-pink);
            color: white;
            padding: 4px 30px;
            font-size: 0.75rem;
            font-weight: 600;
            transform: rotate(45deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .plan-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .plan-icon {
            background-color: #fce4ec; /* Light pink */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .plan-icon svg {
            width: 28px;
            height: 28px;
            fill: var(--primary-pink);
        }

        .plan-details .coins {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .plan-details .bonus {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--online-indicator);
        }

        .plan-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-pink);
            background-color: #fce4ec;
            padding: 8px 12px;
            border-radius: 20px;
        }
        
        /* NEW: TELEGRAM BUTTON STYLE */
        .telegram-support-card {
            margin-top: 25px;
            background: linear-gradient(135deg, #38A5E0, #2A7CB4);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
            cursor: pointer;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(56, 165, 224, 0.4);
            transition: transform 0.2s ease;
        }
        .telegram-support-card:active {
            transform: scale(0.98);
        }
        .telegram-support-card strong {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .telegram-support-card small {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        .telegram-icon {
             width: 30px; height: 30px; fill: white;
        }


        /* --- üìù EDIT PROFILE & TOGGLE STYLES --- */
        #edit-profile-screen {
            justify-content: flex-start;
            padding: 20px;
            background-color: var(--light-bg);
            overflow-y: auto;
        }
        
        .edit-profile-container {
            background-color: var(--content-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow-color);
            margin-top: 20px;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 10px;
        }
        
        .toggle-label {
            font-weight: 600;
            font-size: 1rem;
        }
        
        /* The Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider { background-color: var(--online-indicator); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- üìÑ LEGAL PAGES STYLE --- */
        .legal-content {
            padding: 20px;
            background-color: var(--content-bg);
            border-radius: 15px;
            margin: 20px;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        .legal-content h2 { color: var(--primary-pink); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .legal-content h3 { font-size: 1.1rem; margin-top: 15px; margin-bottom: 8px; color: var(--text-color); }
        .legal-content p, .legal-content li { font-size: 0.9rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 10px; }
        .legal-content ul { padding-left: 20px; }
        .contact-link { color: var(--primary-blue); font-weight: 600; text-decoration: none; }

    </style>
    
    <!-- New Welcome Screen Dependencies -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ee2b8c",
                        "background-light": "#f8f6f7",
                        "background-dark": "#221019",
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                        'glow': '0 0 20px rgba(238, 43, 140, 0.3)',
                    }
                },
            },
        }
    </script>
    <style>
        /* Styles for the new Welcome Screen */
        #welcome-screen.page.active {
            display: block; /* Override flex to allow Tailwind to control layout */
            font-family: 'Plus Jakarta Sans', sans-serif; /* Use the new font */
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(34, 16, 25, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .floating-icon {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        
        /* NEW: 3D Button Style */
        #getStartedBtn {
            box-shadow: 0 5px 0 #c11b6d; /* Darker shade of primary color */
            transition: all 0.1s ease-out;
        }
        #getStartedBtn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 #c11b6d;
        }
        
        /* NEW: Font Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            /* Start with opacity 0 to prevent flash before animation starts */
            opacity: 0; 
            animation: fadeInUp 0.7s ease-out forwards;
        }
    </style>

</head>
<body class="bg-background-light dark:bg-background-dark font-display antialiased text-[#181114] overflow-x-hidden selection:bg-primary selection:text-white">

    <!-- NEW: Main App Container -->
    <div id="app-container">

        <!-- PAGE 1: NEW WELCOME SCREEN -->
        <div id="welcome-screen" class="page">
            <!-- Main Mobile Container -->
            <div class="relative mx-auto flex min-h-screen w-full flex-col overflow-hidden bg-white dark:bg-background-dark shadow-2xl">
            <!-- Background Gradients & Ambient Light -->
            <div class="absolute inset-0 z-0 pointer-events-none">
            <!-- Main soft gradient base -->
            <div class="absolute inset-0 bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 dark:from-[#2a1b25] dark:via-[#221019] dark:to-[#1a1520]"></div>
            <!-- Colorful Orbs for Depth -->
            <div class="absolute top-[-5%] left-[-20%] h-[400px] w-[400px] rounded-full bg-blue-400/20 blur-[80px] mix-blend-multiply dark:bg-blue-600/10"></div>
            <div class="absolute top-[20%] right-[-30%] h-[300px] w-[300px] rounded-full bg-purple-400/20 blur-[60px] mix-blend-multiply dark:bg-purple-600/10"></div>
            <div class="absolute bottom-[-10%] left-[20%] h-[350px] w-[350px] rounded-full bg-primary/15 blur-[70px] mix-blend-multiply dark:bg-primary/10"></div>
            </div>
            <!-- Content Area -->
            <div class="relative z-10 flex h-full flex-grow flex-col justify-between px-6 pt-12 pb-8">
            <!-- 1. Header Area -->
            <div class="flex flex-col items-center">
                <h1 class="text-3xl font-extrabold tracking-tight text-[#181114] dark:text-white drop-shadow-sm animate-fade-in-up">
                    Bat<span class="text-primary">Karo</span>
                </h1>
            </div>
            <!-- 2. Hero Section (Image + Floating Elements) -->
            <div class="relative flex flex-col items-center justify-center py-6">
            <!-- Main Circular Frame -->
            <div class="relative z-10 animate-fade-in-up" style="animation-delay: 0.2s;">
            <!-- Glow effect behind image -->
            <div class="absolute -inset-1 rounded-full bg-gradient-to-tr from-purple-400 to-primary opacity-40 blur-md"></div>
            <!-- Image Container -->
            <div class="relative h-72 w-72 overflow-hidden rounded-full border-[6px] border-white dark:border-white/10 shadow-2xl">
                <!-- MODIFIED: Using <img> tag for better image control -->
                <img src="https://i.ibb.co/8DxPkwCP/uh-OSAwl3-S0-SBZPYo-Wy42y-Q.webp" alt="Welcome Image" class="h-full w-full object-cover transition-transform duration-700 hover:scale-105">
            </div>
            <!-- Floating 3D Icon: Heart (Top Right) -->
            <div class="floating-icon glass-panel absolute -right-2 top-4 flex h-14 w-14 rotate-12 items-center justify-center rounded-2xl">
            <span class="material-symbols-outlined text-[32px] text-primary drop-shadow-sm" style="font-variation-settings: 'FILL' 1, 'wght' 600;">favorite</span>
            </div>
            <!-- Floating 3D Icon: Chat Bubble (Bottom Left) -->
            <div class="floating-icon glass-panel absolute -left-4 bottom-12 flex h-16 w-16 -rotate-6 items-center justify-center rounded-full">
            <span class="material-symbols-outlined text-[36px] text-blue-500 drop-shadow-sm" style="font-variation-settings: 'FILL' 1, 'wght' 500;">chat_bubble</span>
            </div>
            <!-- Floating 3D Icon: Call (Bottom Right) -->
            <div class="floating-icon absolute -bottom-4 right-10 flex h-12 w-12 rotate-6 items-center justify-center rounded-xl bg-white dark:bg-gray-800 shadow-lg border border-gray-100 dark:border-gray-700">
            <span class="material-symbols-outlined text-2xl text-purple-600 dark:text-purple-400" style="font-variation-settings: 'FILL' 1;">call</span>
            </div>
            </div>
            </div>
            <!-- 3. Text & Action Section -->
            <div class="flex flex-col items-center gap-6 text-center">
            <!-- Slogans -->
            <div class="space-y-3">
            <h2 class="px-2 text-[26px] leading-[1.2] font-bold text-[#181114] dark:text-white animate-fade-in-up" style="animation-delay: 0.4s;">
                                    BatKaro ‚Äì Jab Dil Kare,<br/>
            <span class="bg-gradient-to-r from-primary to-purple-600 bg-clip-text text-transparent">Bas Baat Karo</span> ‚ù§Ô∏è
                                </h2>
            <p class="px-6 text-base font-medium text-gray-500 dark:text-gray-400 animate-fade-in-up" style="animation-delay: 0.6s;">
                                    Real Conversations, Real Connections
                                </p>
            </div>
            <!-- Spacer -->
            <div class="h-2"></div>
            <!-- Primary Button -->
            <div class="w-full max-w-[320px] animate-fade-in-up" style="animation-delay: 0.8s;">
                <button id="getStartedBtn" class="group relative flex w-full h-14 cursor-pointer items-center justify-center overflow-hidden rounded-full bg-primary shadow-glow transition-all hover:shadow-[0_0_30px_rgba(238,43,140,0.5)]">
                    <!-- Shine Effect -->
                    <div class="absolute inset-0 -translate-x-full bg-gradient-to-r from-transparent via-white/20 to-transparent transition-transform duration-1000 group-hover:translate-x-full"></div>
                    <span class="text-[17px] font-bold tracking-wide text-white">Get Started</span>
                    <span class="material-symbols-outlined ml-2 text-[20px] text-white transition-transform group-hover:translate-x-1">arrow_forward</span>
                </button>
            </div>
            <!-- iOS Home Indicator Safe Area -->
            <div class="mt-4 h-1.5 w-32 rounded-full bg-gray-200 dark:bg-gray-700 opacity-80"></div>
            </div>
            </div>
            </div>
        </div>
        
        <!-- PAGE: AUTHENTICATION SCREEN -->
        <div id="auth-screen" class="page">
            <div class="auth-container">
                <!-- Sign Up Form -->
                <form id="signup-form" class="auth-form">
                    <h2>Create Account</h2>

                    <!-- *** NEW: Image Upload Section *** -->
                    <div class="image-upload-container">
                        <img id="image-preview" src="https://via.placeholder.com/100" alt="Profile Preview">
                        <label for="signup-image" id="signup-image-label">Choose Profile Picture</label>
                        <input type="file" id="signup-image" accept="image/*">
                        <p id="upload-status"></p>
                        <input type="hidden" id="signup-image-url">
                    </div>

                    <div class="input-group">
                        <label for="signup-name">Name</label>
                        <input type="text" id="signup-name" required>
                    </div>
                    <div class="input-group">
                        <label for="signup-email">Email</label>
                        <input type="email" id="signup-email" required>
                    </div>
                    <div class="input-group">
                        <label for="signup-age">Age</label>
                        <input type="number" id="signup-age" required>
                    </div>
                    <div class="input-group">
                        <label for="signup-gender">Gender</label>
                        <select id="signup-gender" required>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="signup-mobile">Mobile Number</label>
                        <input type="tel" id="signup-mobile" required>
                    </div>
                    <div class="input-group">
                        <label for="signup-password">Password</label>
                        <input type="password" id="signup-password" required minlength="6">
                    </div>
                    <button type="submit">Sign Up</button>
                    <p class="auth-toggle-link">
                        Already have an account? <span id="show-signin-link">Sign In</span>
                    </p>
                </form>
                
                <!-- Sign In Form -->
                <form id="signin-form" class="auth-form hidden">
                    <h2>Welcome Back!</h2>
                    <div class="input-group">
                        <label for="signin-email">Email</label>
                        <input type="email" id="signin-email" required>
                    </div>
                    <div class="input-group">
                        <label for="signin-password">Password</label>
                        <input type="password" id="signin-password" required>
                    </div>
                    <button type="submit">Sign In</button>
                     <p class="auth-toggle-link">
                        Don't have an account? <span id="show-signup-link">Sign Up</span>
                    </p>
                </form>
            </div>
        </div>

        <!-- PAGE 2: HOME SCREEN -->
        <div id="home-screen" class="page">
            <header class="page-header">
                <h1 class="app-logo-home">Batkaro</h1>
                <div class="header-actions">
                    <!-- MODIFIED: Container for two coin types -->
                    <div class="balance-container">
                        <div class="balance-display">
                            <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#C0C0C0" d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2Zm1.6,15.55h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2V8.45h3.2v4.42Z"/></svg>
                            <span id="user-balance-silver">0</span>
                        </div>
                        <div class="balance-separator"></div>
                        <div class="balance-display">
                           <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#FFD700" d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2Zm1.6,15.55h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2V8.45h3.2v4.42Z"/></svg>
                            <span id="user-balance-gold">0</span>
                        </div>
                    </div>
                    <div class="header-profile-icon">
                        <img id="home-profile-img" src="https://via.placeholder.com/100" alt="My Profile">
                    </div>
                </div>
            </header>
            <main class="home-content">
                <div class="random-call-card">
                    <div class="text">
                        <h3>Connect & Make Friends</h3>
                        <p>Voice calls with new people!</p>
                    </div>
                    <button class="random-call-btn">Random Call</button>
                </div>
                 <div class="category-bar-container">
                    <div class="category-item active">All</div><div class="category-item">Star</div><div class="category-item">Relationship</div><div class="category-item">Marriage</div><div class="category-item">Confident</div>
                </div>
                <section class="profile-grid">
                     <!-- Profile cards will be dynamically generated here -->
                </section>
            </main>
        </div>

        <!-- PAGE 3: PROFILE SCREEN -->
        <div id="profile-screen" class="page">
            <header class="profile-header">
                <div class="profile-picture-container">
                    <img id="profile-screen-img" src="https://via.placeholder.com/150" alt="Profile Picture" class="profile-picture">
                </div>
                <div class="profile-actions">
                    <button id="edit-profile-nav-btn" class="profile-action-btn edit-profile-btn">Edit Profile</button>
                    <button class="profile-action-btn add-balance-btn">Add Coins</button>
                </div>
            </header>
            <ul class="settings-list">
                 <li class="settings-item"><span>Transaction</span><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></li>
                 <!-- Change Language Removed -->
                <li class="settings-item"><span>Rate Us</span><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></li>
                <li class="settings-item"><span>Share App</span><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></li>
                <li id="btn-privacy" class="settings-item"><span>Privacy Policy</span><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></li>
                <li id="btn-terms" class="settings-item"><span>Term and Condition</span><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></li>
                <li id="btn-contact" class="settings-item"><span>Contact Us</span><svg class="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></li>
                <li id="logout-btn" class="settings-item"><span>Logout</span></li>
            </ul>
        </div>
        
        <!-- NEW: EDIT PROFILE SCREEN -->
        <div id="edit-profile-screen" class="page">
            <header class="app-header">
                <button class="back-button" data-page="profile-screen">
                     <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1>Edit Profile</h1>
            </header>
            
            <div class="edit-profile-container">
                <!-- Online/Offline Toggle -->
                <div class="toggle-container">
                    <span class="toggle-label">Show Online Status</span>
                    <label class="switch">
                        <input type="checkbox" id="online-status-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <form id="edit-profile-form" class="auth-form">
                    <div class="input-group">
                        <label for="edit-name">Name</label>
                        <input type="text" id="edit-name" required>
                    </div>
                    <div class="input-group">
                        <label for="edit-age">Age</label>
                        <input type="number" id="edit-age" required>
                    </div>
                    <div class="input-group">
                        <label for="edit-about">About Me</label>
                        <textarea id="edit-about" rows="3" placeholder="Tell something about yourself..."></textarea>
                    </div>
                    <button type="submit">Save Changes</button>
                </form>
            </div>
        </div>

        <!-- NEW: PRIVACY POLICY SCREEN -->
        <div id="privacy-screen" class="page">
            <header class="app-header">
                <button class="back-button" data-page="profile-screen">
                     <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1>Privacy Policy</h1>
            </header>
            <div class="legal-content">
                <h2>Privacy Policy</h2>
                <p>Welcome to Batkaro. Your privacy is critically important to us. This Privacy Policy explains how we collect, use, and share your personal information when you use our services.</p>
                
                <h3>1. Information We Collect</h3>
                <ul>
                    <li><strong>Account Information:</strong> When you sign up, we collect your Name, Email, Age, Gender, and Profile Picture to create your unique identity.</li>
                    <li><strong>Usage Data:</strong> We may collect data about your interactions with other users, call duration, and transaction history.</li>
                    <li><strong>Device Permissions:</strong> We require access to your Camera and Microphone to facilitate Video and Audio calling features. This data is transmitted in real-time and is not stored permanently on our servers.</li>
                </ul>

                <h3>2. How We Use Your Information</h3>
                <p>We use your data to:</p>
                <ul>
                    <li>Facilitate connections between users.</li>
                    <li>Process payments via Razorpay for Coin purchases.</li>
                    <li>Improve app stability and user experience.</li>
                    <li>Prevent fraud and ensure community safety.</li>
                </ul>

                <h3>3. Data Storage and Security</h3>
                <p>We use Firebase (Google) services for secure data storage and authentication. While we implement strong security measures, no method of transmission over the internet is 100% secure.</p>

                <h3>4. Payments</h3>
                <p>All financial transactions are processed through Razorpay. We do not store your credit card or banking details on our servers.</p>

                <h3>5. Contact Us</h3>
                <p>If you have questions about this Privacy Policy, please contact us at: <a href="mailto:udbhavscience12@gmail.com" class="contact-link">udbhavscience12@gmail.com</a></p>
            </div>
        </div>

        <!-- NEW: TERMS AND CONDITIONS SCREEN -->
        <div id="terms-screen" class="page">
            <header class="app-header">
                <button class="back-button" data-page="profile-screen">
                     <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1>Terms & Conditions</h1>
            </header>
            <div class="legal-content">
                <h2>Terms and Conditions</h2>
                <p>By downloading or using the Batkaro app, these terms will automatically apply to you.</p>

                <h3>1. User Eligibility</h3>
                <p>You must be at least 18 years of age to use Batkaro. By using the app, you confirm that you meet this age requirement.</p>

                <h3>2. User Conduct</h3>
                <p>You agree not to:</p>
                <ul>
                    <li>Harass, abuse, or threaten other users.</li>
                    <li>Share illegal, explicit, or offensive content.</li>
                    <li>Use the app for any fraudulent activity.</li>
                </ul>
                <p>Violation of these rules will result in immediate account suspension without refund.</p>

                <h3>3. Virtual Currency (Coins)</h3>
                <p>Batkaro uses "Gold Coins" and "Silver Coins" as virtual currency. Coins have no real-world monetary value and cannot be exchanged for cash. All purchases are final and non-refundable.</p>

                <h3>4. Liability</h3>
                <p>Batkaro is a platform for social interaction. We are not responsible for the behavior of users offline or outside the platform. Please use caution when sharing personal information.</p>

                <h3>5. Changes to Terms</h3>
                <p>We reserve the right to update these terms at any time. Continued use of the app implies acceptance of the new terms.</p>
            </div>
        </div>

        <!-- NEW: CONTACT US SCREEN -->
        <div id="contact-screen" class="page">
            <header class="app-header">
                <button class="back-button" data-page="profile-screen">
                     <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1>Contact Us</h1>
            </header>
            <div class="legal-content">
                <h2>Get in Touch</h2>
                <p>We are here to help you. If you are facing any issues with the app, payments, or have any feedback, please reach out to us.</p>
                
                <h3>Support Email</h3>
                <p>You can email us directly at:</p>
                <p><a href="mailto:udbhavscience12@gmail.com" class="contact-link" style="font-size: 1.1rem;">udbhavscience12@gmail.com</a></p>
                
                <h3>Response Time</h3>
                <p>We typically respond within 24-48 hours.</p>
            </div>
        </div>
        
        <!-- PAGE 4: CHAT LIST SCREEN -->
        <div id="chat-list-screen" class="page">
            <header class="app-header">
                <h1>Chats</h1>
            </header>
            <main>
                <ul class="chat-list">
                    <!-- Chat list items will be dynamically generated here -->
                </ul>
            </main>
        </div>

        <!-- PAGE 5: CHAT CONVERSATION SCREEN -->
        <div id="chat-conversation-screen" class="page">
            <header class="app-header">
                <button class="back-button" data-page="chat-list-screen">
                     <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <div class="chat-header-info">
                    <img src="" alt="Profile Pic"> <!-- Image src will be set by JS -->
                    <div class="details">
                        <span class="name"></span> <!-- Name will be set by JS -->
                        <span class="status">online</span>
                    </div>
                </div>
            </header>
            <main class="chat-messages">
                <!-- Messages will be loaded from Firebase here -->
            </main>
            <footer class="chat-input-area">
                <input id="chat-input-field" type="text" placeholder="Type a message... (2 Silver Coins/min)">
                <button id="send-message-btn" class="send-btn"><svg viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"></path></svg></button>
            </footer>
        </div>
        
        <!-- PAGE 6: RECENT CALLS SCREEN -->
        <div id="recent-screen" class="page">
            <header class="app-header">
                <h1>Recent Calls</h1>
            </header>
            <main>
                <ul id="recent-calls-list" class="chat-list">
                    <!-- Recent call items will be dynamically inserted here -->
                </ul>
            </main>
        </div>

        <!-- NEW PAGE 7: ACTIVE CALL SCREEN (WEBRTC) -->
        <div id="call-screen" class="page">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay playsinline muted></video>
            <div class="call-controls">
                <button class="call-btn-circle btn-mic">
                   <svg viewBox="0 0 24 24"><path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"></path></svg>
                </button>
                <button id="hangupBtn" class="call-btn-circle btn-hangup">
                    <svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 8.85,9.25 7.4,9.72L2.73,5.06L4.14,3.64C6.38,2.6 8.92,2 11.5,2C14.08,2 16.62,2.6 18.86,3.64L20.27,5.06L15.6,9.72C14.15,9.25 12.6,9 12,9Z" transform="rotate(180 12 12)"></path></svg>
                </button>
                <!-- CHANGE: Added camera switch button -->
                <button id="switchCameraBtn" class="call-btn-circle btn-switch-camera">
                    <svg viewBox="0 0 24 24"><path d="M20,4H4C2.89,4 2,4.89 2,6V18C2,19.1 2.9,20 4,20H20C21.1,20 22,19.1 22,18V6C22,4.89 21.1,4 20,4M20,18H4V6H20V18M17.5,12.5V15.5H16V12.5H14L16.5,9.5L19,12.5H17.5M6.5,11.5V8.5H8V11.5H10L7.5,14.5L5,11.5H6.5Z" transform="rotate(90 12 12)"></path></svg>
                </button>
            </div>
        </div>
        
        <!-- NEW: RECHARGE STORE PAGE -->
        <div id="recharge-screen" class="page">
             <header class="app-header">
                <button class="back-button" data-page="profile-screen">
                     <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h1>Store</h1>
            </header>
            <div class="store-content">
                <!-- Gold Coins Section -->
                <div class="store-section">
                    <div class="store-section-header">
                        <h2>
                           <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#FFD700" d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2Zm1.6,15.55h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2V8.45h3.2v4.42Z"/></svg>
                            Gold Coins
                        </h2>
                        <p>For high-quality Video Calls</p>
                    </div>
                    <div id="recharge-plans-gold" class="recharge-plans-container">
                        <!-- Gold recharge plans will be dynamically inserted here -->
                    </div>
                </div>

                <!-- Silver Coins Section -->
                <div class="store-section">
                     <div class="store-section-header">
                        <h2>
                             <svg class="coin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#C0C0C0" d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2Zm1.6,15.55h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2V8.45h3.2v4.42Z"/></svg>
                            Silver Coins
                        </h2>
                        <p>For Voice Calls and Chatting</p>
                    </div>
                    <div id="recharge-plans-silver" class="recharge-plans-container">
                        <!-- Silver recharge plans will be dynamically inserted here -->
                    </div>
                </div>

                 <a id="telegram-support-btn" href="https://t.me/Himversa7" target="_blank" class="telegram-support-card">
                    <svg class="telegram-icon" viewBox="0 0 24 24"><path d="M9.78,18.65L10.26,14.21L18.73,7.45C19.19,7.08 18.83,6.37 18.29,6.5L3.3,12.41C2.69,12.64 2.68,13.54 3.28,13.79L8.03,15.75L15.34,9.41C15.68,9.15 16.13,9.45 15.89,9.75L9.78,18.65Z"></path></svg>
                    <strong>Need Help? DM on Telegram</strong>
                    <small>Contact @Himversa7 for payment support & offers</small>
                </a>
            </div>
        </div>


        <!-- INCOMING CALL MODAL -->
        <div id="incoming-call-modal">
            <img id="incoming-caller-img" src="" alt="Caller" class="caller-img-large">
            <div class="caller-name-display" id="incoming-caller-name">Unknown</div>
            <div class="incoming-actions">
                <button id="reject-call-btn" class="call-btn-circle btn-hangup">
                    <svg viewBox="0 0 24 24"><path d="M12,9C10.4,9 8.85,9.25 7.4,9.72L2.73,5.06L4.14,3.64C6.38,2.6 8.92,2 11.5,2C14.08,2 16.62,2.6 18.86,3.64L20.27,5.06L15.6,9.72C14.15,9.25 12.6,9 12,9Z" transform="rotate(180 12 12)"></path></svg>
                </button>
                <button id="accept-call-btn" class="call-btn-circle btn-accept">
                    <svg viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"></path></svg>
                </button>
            </div>
        </div>

        <!-- REGULAR USER BOTTOM NAVIGATION BAR -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-page="home-screen"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg></div>
            <div class="nav-item" data-page="chat-list-screen"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></div>
            <div class="nav-item" data-page="recent-screen"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
            <div class="nav-item" data-page="profile-screen"><svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
        </nav>
    
    </div> <!-- End of #app-container -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    <!-- NEW: Firebase Cloud Messaging SDK for Push Notifications -->
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-messaging.js"></script>


    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB2PG5JvDko2UmQDlY9gN5lBgga2vQy-Ws",
            authDomain: "conceptra-c1000.firebaseapp.com",
            databaseURL: "https://conceptra-c1000-default-rtdb.firebaseio.com",
            projectId: "conceptra-c1000",
            storageBucket: "conceptra-c1000.appspot.com",
            messagingSenderId: "298402987968",
            appId: "1:298402987968:web:c0d0d7d6c08cdfa6bc5225",
            measurementId: "G-QRQYEVSJJ6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const firestore = firebase.firestore();

        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-item');
            const getStartedBtn = document.getElementById('getStartedBtn');
            const bottomNav = document.querySelector('.bottom-nav');
            
            // Auth elements
            const signupForm = document.getElementById('signup-form');
            const signinForm = document.getElementById('signin-form');
            const showSigninLink = document.getElementById('show-signin-link');
            const showSignupLink = document.getElementById('show-signup-link');
            const logoutBtn = document.getElementById('logout-btn');

            // Cloudinary and Image Upload Elements
            const signupImageInput = document.getElementById('signup-image');
            const imagePreview = document.getElementById('image-preview');
            const signupImageUrlInput = document.getElementById('signup-image-url');
            const uploadStatus = document.getElementById('upload-status');
            const signupButton = signupForm.querySelector('button[type="submit"]');
            
            // Balance and Recharge Elements
            const userBalanceSilverDisplay = document.getElementById('user-balance-silver');
            const userBalanceGoldDisplay = document.getElementById('user-balance-gold');
            const goldRechargePlansContainer = document.getElementById('recharge-plans-gold');
            const silverRechargePlansContainer = document.getElementById('recharge-plans-silver');
            const homeProfileImg = document.getElementById('home-profile-img');
            const profileScreenImg = document.getElementById('profile-screen-img');


            // Edit Profile Elements
            const editProfileNavBtn = document.getElementById('edit-profile-nav-btn');
            const editProfileForm = document.getElementById('edit-profile-form');
            const onlineStatusToggle = document.getElementById('online-status-toggle');

            const CLOUD_NAME = 'dtvrhjtt4';
            const UPLOAD_PRESET = 'Soul_Spark';
            const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

            let currentChatId = null;
            let currentUserId = null; 
            // MODIFIED: Separate coin balances
            let currentUserSilverCoins = 0;
            let currentUserGoldCoins = 0;
            let currentOpenChatOtherUserId = null; 

            // MODIFIED: Costs constants updated for clarity
            const COST_CHAT_PER_MIN = 2;    // Silver Coins
            const COST_VOICE_PER_MIN = 3;   // Silver Coins
            const COST_VIDEO_PER_MIN = 10;  // Gold Coins

            let messagesRef = null;
            let messagesListener = null;
            let chatListListener = null;
            
            // WEBRTC Variables
            let localStream = null;
            let remoteStream = null;
            let peerConnection = null;
            let currentCallId = null;
            let callRef = null;
            let currentFacingMode = 'user';
            let activeCallInterval = null;
            let activeChatInterval = null; 
            
            const servers = {
                iceServers: [
                    {
                        urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302']
                    }
                ],
                iceCandidatePoolSize: 10,
            };

            // Call UI Elements
            const callScreen = document.getElementById('call-screen');
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            const hangupBtn = document.getElementById('hangupBtn');
            const incomingCallModal = document.getElementById('incoming-call-modal');
            const acceptCallBtn = document.getElementById('accept-call-btn');
            const rejectCallBtn = document.getElementById('reject-call-btn');
            const incomingCallerName = document.getElementById('incoming-caller-name');
            const incomingCallerImg = document.getElementById('incoming-caller-img');
            const switchCameraBtn = document.getElementById('switchCameraBtn');
            
            // --- Mock DB for active chats (will be replaced by Firebase listener) ---
            const db = {
                activeChats: []
            };

            // --- Page Navigation (Simplified) ---
            const showPage = (pageId) => {
                if (document.getElementById('chat-conversation-screen').classList.contains('active') && pageId !== 'chat-conversation-screen') {
                    stopChatTimer();
                }
                
                pages.forEach(page => page.classList.remove('active'));
                const pageToShow = document.getElementById(pageId);
                if (pageToShow) {
                    pageToShow.classList.add('active');
                }
                
                const pagesWithoutNav = ['welcome-screen', 'auth-screen', 'chat-conversation-screen', 'call-screen', 'edit-profile-screen', 'privacy-screen', 'terms-screen', 'contact-screen', 'recharge-screen'];
                if (pagesWithoutNav.includes(pageId)) {
                    bottomNav.style.display = 'none';
                } else {
                    bottomNav.style.display = 'flex';
                }

                navItems.forEach(item => {
                    const isChatRelated = item.dataset.page === 'chat-list-screen' && (pageId === 'chat-list-screen' || pageId === 'chat-conversation-screen');
                    item.classList.toggle('active', item.dataset.page === pageId || isChatRelated);
                });
            };
            
            // --- Central Authentication Logic ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUserId = user.uid;
                    listenForUserData(user.uid);
                    listenForNewChats(user.uid);
                    listenForIncomingCalls(user.uid); 
                    fetchAllUsers();
                    setupPushNotifications(); // NEW: Setup push notifications on login
                    showPage('home-screen'); 
                } else {
                    currentUserId = null;
                    if (chatListListener) chatListListener.off();
                    document.querySelector('.profile-grid').innerHTML = '';
                    document.querySelector('.chat-list').innerHTML = '';
                    showPage('welcome-screen');
                }
            });

            // MODIFIED: Listen for user data from Firestore with both coin types
            function listenForUserData(uid) {
                firestore.collection('users').doc(uid).onSnapshot(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        currentUserSilverCoins = userData.silverCoins || 0;
                        currentUserGoldCoins = userData.goldCoins || 0;
                        updateBalanceDisplay(currentUserSilverCoins, currentUserGoldCoins);
                        if(userData.profileImg) {
                            homeProfileImg.src = userData.profileImg;
                            profileScreenImg.src = userData.profileImg;
                        }
                    }
                });
            }

            // MODIFIED: Update balance display for both coins
            function updateBalanceDisplay(silver, gold) {
                userBalanceSilverDisplay.textContent = silver;
                userBalanceGoldDisplay.textContent = gold;
            }

            // --- NEW: PUSH NOTIFICATION SETUP ---
            async function setupPushNotifications() {
                // Step 1: Create and Register the Service Worker
                const swCode = `
                    importScripts('https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js');
                    importScripts('https://www.gstatic.com/firebasejs/8.6.1/firebase-messaging.js');
                    
                    const firebaseConfig = ${JSON.stringify(firebaseConfig)};
                    firebase.initializeApp(firebaseConfig);
                    
                    const messaging = firebase.messaging();
                    
                    messaging.onBackgroundMessage((payload) => {
                        console.log('Received background message ', payload);
                        
                        const notificationTitle = payload.notification.title;
                        const notificationOptions = {
                            body: payload.notification.body,
                            icon: payload.notification.icon || '/favicon.ico'
                        };
                        
                        self.registration.showNotification(notificationTitle, notificationOptions);
                    });
                `;

                try {
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swReg = await navigator.serviceWorker.register(URL.createObjectURL(blob));
                    console.log('Service Worker registered successfully', swReg);
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                    return;
                }

                // Step 2: Request Permission and Get Token
                if ('Notification' in window && 'serviceWorker' in navigator && 'PushManager' in window) {
                    const messaging = firebase.messaging();
                    try {
                        await Notification.requestPermission();
                        const fcmToken = await messaging.getToken({
                            serviceWorkerRegistration: await navigator.serviceWorker.ready,
                            // MODIFIED: Added VAPID key from the provided image
                            vapidKey: 'BMrus7tqbVWPAYlWOhaiBPs.Gch_uiE9XjQZMWi4aqqoMnZJrumoohBTfIRlu-c2jLWzLeHqcRd_4cRLbB4glO' 
                        });

                        if (fcmToken) {
                            console.log('FCM Token:', fcmToken);
                            // Save this token to the user's document in Firestore
                            await firestore.collection('users').doc(currentUserId).update({
                                fcmToken: fcmToken
                            });
                        } else {
                            console.log('No registration token available. Request permission to generate one.');
                        }
                    } catch (err) {
                        console.error('An error occurred while retrieving token. ', err);
                    }
                }
            }


            // --- Event Listeners ---
            getStartedBtn.addEventListener('click', () => {
                showPage('auth-screen');
            });
            
            showSigninLink.addEventListener('click', () => {
                signupForm.classList.add('hidden');
                signinForm.classList.remove('hidden');
            });

            showSignupLink.addEventListener('click', () => {
                signinForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            });

            // --- Legal Pages Navigation ---
            const openLegalPage = (btnId, pageId) => {
                const btn = document.getElementById(btnId);
                if(btn) {
                    btn.addEventListener('click', () => { showPage(pageId); });
                }
            };
            openLegalPage('btn-privacy', 'privacy-screen');
            openLegalPage('btn-terms', 'terms-screen');
            openLegalPage('btn-contact', 'contact-screen');
            
            // Cloudinary Image Upload Function
            async function uploadImageToCloudinary(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);
                
                try {
                    const response = await fetch(CLOUDINARY_URL, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    return data.secure_url;
                } catch (error) {
                    console.error('Error uploading to Cloudinary:', error);
                    return null;
                }
            }

            signupImageInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                imagePreview.style.display = 'block';
                imagePreview.src = URL.createObjectURL(file);
                
                uploadStatus.textContent = 'Uploading image...';
                signupButton.disabled = true;

                const imageUrl = await uploadImageToCloudinary(file);

                if (imageUrl) {
                    signupImageUrlInput.value = imageUrl;
                    uploadStatus.textContent = 'Image uploaded successfully!';
                    signupButton.disabled = false;
                } else {
                    uploadStatus.textContent = 'Upload failed. Please try again.';
                    alert('Image upload failed. Please select another image.');
                    signupImageUrlInput.value = '';
                    imagePreview.style.display = 'none';
                    signupButton.disabled = false;
                }
            });

            // MODIFIED: Signup Form Submission with new coin structure
            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const profileImg = signupImageUrlInput.value;
                if (!profileImg) {
                    alert('Please choose a profile picture and wait for it to upload.');
                    return;
                }

                const name = signupForm['signup-name'].value;
                const email = signupForm['signup-email'].value;
                const age = signupForm['signup-age'].value;
                const gender = signupForm['signup-gender'].value;
                const mobile = signupForm['signup-mobile'].value;
                const password = signupForm['signup-password'].value;

                auth.createUserWithEmailAndPassword(email, password)
                    .then(cred => {
                        return firestore.collection('users').doc(cred.user.uid).set({
                            uid: cred.user.uid,
                            name: name,
                            age: age,
                            gender: gender,
                            mobile: mobile,
                            email: email,
                            profileImg: profileImg,
                            silverCoins: 50, // Give new users 50 free silver coins
                            goldCoins: 0,    // Start with 0 gold coins
                            isOnline: true,
                            about: "Hey there! I am using Batkaro.",
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    })
                    .then(() => {
                        signupForm.reset();
                        imagePreview.style.display = 'none';
                        uploadStatus.textContent = '';
                    })
                    .catch(err => {
                        alert(err.message);
                    });
            });

            signinForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = signinForm['signin-email'].value;
                const password = signinForm['signin-password'].value;
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => { 
                        signinForm.reset(); 
                    })
                    .catch(err => { alert("Failed to sign in. Please check your email and password."); console.error(err); });
            });

            logoutBtn.addEventListener('click', () => {
                auth.signOut();
            });

            navItems.forEach(item => {
                item.addEventListener('click', () => { showPage(item.dataset.page); });
            });
            
            document.body.addEventListener('click', (e) => {
                const backButton = e.target.closest('.back-button');
                if (backButton) { showPage(backButton.dataset.page); }
                
                // ** CHAT BUTTON CLICK **
                const chatBtn = e.target.closest('.chat-btn');
                if (chatBtn) {
                     if (!currentUserId) { alert("Please sign in to chat."); return; }
                    openChat(chatBtn.dataset.profileUid, chatBtn.dataset.profileName, chatBtn.dataset.profileImg);
                }

                // ** VOICE CALL BUTTON CLICK **
                const voiceBtn = e.target.closest('.voice-btn');
                if (voiceBtn) {
                     if (!currentUserId) { alert("Please sign in to call."); return; }
                     const profileCard = voiceBtn.closest('.profile-card');
                     const uid = profileCard.dataset.profileUid;
                     if(uid) startCall(uid, false); // false = Audio Only
                }

                // ** VIDEO CALL BUTTON CLICK **
                const videoBtn = e.target.closest('.video-btn');
                if (videoBtn) {
                     if (!currentUserId) { alert("Please sign in to call."); return; }
                     const profileCard = videoBtn.closest('.profile-card');
                     const uid = profileCard.dataset.profileUid;
                     if(uid) startCall(uid, true); // true = Video Call
                }

                const chatListItem = e.target.closest('.chat-list-item');
                if(chatListItem) {
                    openChat(chatListItem.dataset.otherUserId, chatListItem.dataset.profileName, chatListItem.dataset.profileImg);
                }
                
                // Add balance button from profile
                const addBalanceBtn = e.target.closest('.add-balance-btn');
                if(addBalanceBtn) {
                    showPage('recharge-screen');
                    generateRechargePlans();
                }
            });

            // --- EDIT PROFILE FUNCTIONALITY ---
            editProfileNavBtn.addEventListener('click', async () => {
                if(!currentUserId) return;
                
                try {
                    const userDoc = await firestore.collection('users').doc(currentUserId).get();
                    if(userDoc.exists) {
                        const data = userDoc.data();
                        document.getElementById('edit-name').value = data.name || '';
                        document.getElementById('edit-age').value = data.age || '';
                        document.getElementById('edit-about').value = data.about || '';
                        onlineStatusToggle.checked = data.isOnline !== false;
                    }
                    showPage('edit-profile-screen');
                } catch (e) {
                    console.error("Error loading profile", e);
                }
            });

            editProfileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if(!currentUserId) return;

                const newName = document.getElementById('edit-name').value;
                const newAge = document.getElementById('edit-age').value;
                const newAbout = document.getElementById('edit-about').value;
                const isOnline = onlineStatusToggle.checked;

                try {
                    await firestore.collection('users').doc(currentUserId).update({
                        name: newName,
                        age: newAge,
                        about: newAbout,
                        isOnline: isOnline
                    });
                    alert("Profile updated successfully!");
                    showPage('profile-screen');
                } catch (error) {
                    console.error("Error updating profile:", error);
                    alert("Failed to update profile.");
                }
            });


            // --- MODIFIED RECHARGE STORE LOGIC ---
            function generateRechargePlans() {
                goldRechargePlansContainer.innerHTML = '';
                silverRechargePlansContainer.innerHTML = '';
                
                // Gold Coin Plans (for video calls)
                const goldPlans = [
                    { amount: 450, coins: 400, bonus: 50, tag: 'Starter' },
                    { amount: 900, coins: 800, bonus: 150, tag: 'Popular' },
                    { amount: 2000, coins: 1800, bonus: 400, tag: 'Best Value' }
                ];
                
                // Silver Coin Plans (for voice and chat)
                const silverPlans = [
                    { amount: 5, coins: 50, bonus: 0, tag: 'Trial' },
                    { amount: 50, coins: 500, bonus: 50, tag: 'Basic' },
                    { amount: 100, coins: 1000, bonus: 150, tag: 'Value' }
                ];

                const createPlanElement = (plan, coinType) => {
                    const planElement = document.createElement('div');
                    planElement.className = 'recharge-plan';
                    if (plan.tag === 'Best Value') {
                        planElement.classList.add('best-value');
                    }

                    const totalCoins = plan.coins + plan.bonus;
                    const coinIconColor = coinType === 'gold' ? 'var(--gold-coin)' : 'var(--silver-coin)';
                    
                    let tagHTML = '';
                    if(plan.tag){
                         tagHTML = `<div class="plan-tag">${plan.tag}</div>`;
                    }

                    planElement.innerHTML = `
                        ${tagHTML}
                        <div class="plan-info">
                             <div class="plan-icon">
                                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="${coinIconColor}" d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10,10-4.48,10-10S17.52,2,12,2Zm1.6,15.55h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2v-1.12h3.2v1.12Zm0-2.23h-3.2V8.45h3.2v4.42Z"/></svg>
                             </div>
                             <div class="plan-details">
                                <span class="coins">${totalCoins} ${coinType.charAt(0).toUpperCase() + coinType.slice(1)} Coins</span>
                                ${plan.bonus > 0 ? `<span class="bonus">+${plan.bonus} Bonus Coins!</span>` : ''}
                             </div>
                        </div>
                        <div class="plan-price">‚Çπ ${plan.amount}</div>
                    `;

                    planElement.addEventListener('click', () => {
                        initiateRecharge(plan.amount, totalCoins, coinType);
                    });
                    
                    return planElement;
                };
                
                goldPlans.forEach(plan => {
                    goldRechargePlansContainer.appendChild(createPlanElement(plan, 'gold'));
                });

                silverPlans.forEach(plan => {
                    silverRechargePlansContainer.appendChild(createPlanElement(plan, 'silver'));
                });
            }

            // --- MODIFIED RAZORPAY PAYMENT INTEGRATION ---
            async function initiateRecharge(amount, coinsToAdd, coinType) {
                if (!currentUserId) {
                    alert("Please login first to recharge.");
                    return;
                }

                try {
                    const options = {
                        "key": "rzp_test_YourKey", // Replace with your actual Razorpay Key
                        "amount": amount * 100, // Amount in paise
                        "currency": "INR",
                        "name": "Batkaro App",
                        "description": `${coinsToAdd} ${coinType} Coins Recharge`,
                        "handler": async function (response) {
                            console.log("Payment Successful", response);
                            alert("Payment Successful! Payment ID: " + response.razorpay_payment_id);
                            addCoinsToDatabase(coinsToAdd, coinType);
                        },
                        "prefill": {
                            "email": auth.currentUser.email 
                        },
                        "theme": {
                            "color": "#E91E63"
                        }
                    };

                    const rzp1 = new Razorpay(options);
                    rzp1.on('payment.failed', function (response){
                        alert("Payment Failed: " + response.error.description);
                        console.error(response.error);
                    });

                    rzp1.open();
                } catch (error) {
                    console.error("Payment Error: ", error);
                    alert("Payment failed to start. Please try again or contact support on Telegram.");
                }
            }

            // --- MODIFIED: Add Coins to Firebase ---
            async function addCoinsToDatabase(coins, coinType) {
                if (!currentUserId) return;
                try {
                    const userRef = firestore.collection('users').doc(currentUserId);
                    const fieldToUpdate = coinType === 'gold' ? 'goldCoins' : 'silverCoins';
                    
                    await userRef.update({
                        [fieldToUpdate]: firebase.firestore.FieldValue.increment(coins)
                    });
                    
                    alert(`Congratulations! ${coins} ${coinType} coins have been added to your account.`);
                    showPage('home-screen'); // Go back home after successful recharge
                } catch (error) {
                    console.error("Error adding coins to database:", error);
                    alert("There was an error adding coins. Please contact support.");
                }
            }
            
            // --- MODIFIED BILLING FUNCTIONS ---
            function startCallTimer(costPerMinute, coinType) {
                if(activeCallInterval) clearInterval(activeCallInterval);
                
                activeCallInterval = setInterval(async () => {
                    if(!currentUserId) {
                        stopCallTimer();
                        return;
                    }
                    
                    const currentBalance = coinType === 'gold' ? currentUserGoldCoins : currentUserSilverCoins;
                    if (currentBalance < costPerMinute) {
                         endCall();
                         alert("Call ended: Insufficient coins.");
                         return;
                    }

                    try {
                        const userRef = firestore.collection('users').doc(currentUserId);
                        const fieldToUpdate = coinType === 'gold' ? 'goldCoins' : 'silverCoins';
                        await userRef.update({
                            [fieldToUpdate]: firebase.firestore.FieldValue.increment(-costPerMinute)
                        });
                    } catch (e) {
                        console.error("Deduction error", e);
                        endCall();
                    }
                }, 60000);
            }
            
            function stopCallTimer() {
                if(activeCallInterval) {
                    clearInterval(activeCallInterval);
                    activeCallInterval = null;
                }
            }
            
            function stopChatTimer() {
                if(activeChatInterval) {
                    clearInterval(activeChatInterval);
                    activeChatInterval = null;
                    console.log("Chat billing stopped.");
                }
            }


            // --- CHAT AND USER-RELATED FUNCTIONS ---
            function markMessagesAsSeen(chatId, otherUserId) {
                if (!chatId || !otherUserId) return;
                const messagesRef = database.ref(`chats/${chatId}`);
                messagesRef.orderByChild('senderId').equalTo(otherUserId).once('value', snapshot => {
                    snapshot.forEach(childSnapshot => {
                        const message = childSnapshot.val();
                        if (message.status !== 'seen') {
                            childSnapshot.ref.update({ status: 'seen' });
                        }
                    });
                });
            }

            // MODIFIED: openChat now uses and deducts Silver Coins
            async function openChat(otherUserId, name, img) {
                if (!currentUserId || !otherUserId) return;

                if (currentUserSilverCoins < COST_CHAT_PER_MIN) {
                    alert("You need at least " + COST_CHAT_PER_MIN + " Silver Coins to start chatting. Please recharge.");
                    showPage('recharge-screen');
                    generateRechargePlans();
                    return;
                }
                
                stopChatTimer();

                try {
                    const userRef = firestore.collection('users').doc(currentUserId);
                    await userRef.update({
                        silverCoins: firebase.firestore.FieldValue.increment(-COST_CHAT_PER_MIN)
                    });

                    activeChatInterval = setInterval(async () => {
                        if (currentUserSilverCoins < COST_CHAT_PER_MIN) {
                            stopChatTimer();
                            alert("Chat ended due to insufficient Silver Coins. Please recharge to continue.");
                            showPage('recharge-screen');
                            generateRechargePlans();
                            return;
                        }
                        await userRef.update({
                            silverCoins: firebase.firestore.FieldValue.increment(-COST_CHAT_PER_MIN)
                        });
                    }, 60000);

                    console.log("Chat billing started (Silver Coins).");
                } catch (error) {
                    console.error("Error starting chat billing:", error);
                    alert("A billing error occurred. Please try again.");
                    return;
                }

                const ids = [currentUserId, otherUserId].sort();
                currentChatId = ids.join('_');
                currentOpenChatOtherUserId = otherUserId;

                const headerInfo = document.querySelector('#chat-conversation-screen .chat-header-info');
                headerInfo.querySelector('.name').textContent = name;
                headerInfo.querySelector('img').src = img;
                
                loadMessages(currentChatId);
                markMessagesAsSeen(currentChatId, otherUserId);
                showPage('chat-conversation-screen');
            }

            function loadMessages(chatId) {
                if (messagesRef) { 
                    messagesRef.off(); 
                }
                const messagesContainer = document.querySelector('.chat-messages');
                messagesContainer.innerHTML = '';
                messagesRef = database.ref(`chats/${chatId}`);
                messagesListener = messagesRef.orderByChild('timestamp').limitToLast(100).on('child_added', (snapshot) => {
                    const message = snapshot.val();
                    displayMessage(snapshot.key, message);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
            }

            function displayMessage(messageId, message) {
                const messagesContainer = document.querySelector('.chat-messages');
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('message-bubble', message.senderId === currentUserId ? 'sent' : 'received');

                const getTicksHTML = (status) => {
                    if (status === 'sent') return '<span class="ticks">‚úì</span>'; 
                    return `<span class="ticks ${status === 'seen' ? 'seen' : ''}">‚úì‚úì</span>`;
                };

                messageBubble.innerHTML = `
                    <span class="message-content">${message.text}</span>
                    <div class="message-meta">
                        <span class="timestamp">${new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                        ${message.senderId === currentUserId ? getTicksHTML(message.status) : ''}
                    </div>
                `;
                messagesContainer.appendChild(messageBubble);
            }
            
            // MODIFIED: sendMessage now checks for Silver Coins
            async function sendMessage() {
                const chatInput = document.getElementById('chat-input-field');
                const messageText = chatInput.value.trim();
                if (messageText === '' || !currentChatId || !currentUserId) return;

                if (currentUserSilverCoins < 1) { // Check if user has at least 1 silver coin to send a message
                     alert("Low balance! Please recharge Silver Coins to continue chatting.");
                     showPage('recharge-screen');
                     generateRechargePlans();
                     return;
                }

                try {
                    const myProfileDoc = await firestore.collection('users').doc(currentUserId).get();
                    const otherProfileDoc = await firestore.collection('users').doc(currentOpenChatOtherUserId).get();

                    if (!myProfileDoc.exists || !otherProfileDoc.exists) {
                        alert("Cannot send message. User profile not found.");
                        return;
                    }
                    
                    const myProfileData = myProfileDoc.data();
                    const otherProfileData = otherProfileDoc.data();

                    const messageData = { senderId: currentUserId, text: messageText, timestamp: firebase.database.ServerValue.TIMESTAMP, status: 'sent' };
                    await database.ref(`chats/${currentChatId}`).push().set(messageData);
                    
                    const chatInfo = { lastMessage: messageText, timestamp: firebase.database.ServerValue.TIMESTAMP };
                    await database.ref(`userChats/${currentUserId}/${currentOpenChatOtherUserId}`).set({ ...chatInfo, withUserName: otherProfileData.name, withUserImg: otherProfileData.profileImg });
                    await database.ref(`userChats/${currentOpenChatOtherUserId}/${currentUserId}`).set({ ...chatInfo, withUserName: myProfileData.name, withUserImg: myProfileData.profileImg });
                    
                    chatInput.value = '';
                } catch (error) {
                    console.error("Error sending message:", error);
                    alert("Failed to send message. Please check your connection.");
                }
            }

            function listenForNewChats(uid) {
                if (chatListListener) chatListListener.off();
                chatListListener = database.ref(`userChats/${uid}`);
                chatListListener.on('value', snapshot => {
                    db.activeChats = [];
                    snapshot.forEach(child => {
                        db.activeChats.push({ otherUserId: child.key, ...child.val() });
                    });
                    db.activeChats.sort((a, b) => b.timestamp - a.timestamp);
                    renderChatList();
                });
            }

            function renderChatList() {
                const chatList = document.querySelector('#chat-list-screen .chat-list');
                chatList.innerHTML = '';
                if (db.activeChats.length === 0) {
                    chatList.innerHTML = `<p class="empty-list-placeholder">No active chats.</p>`;
                    return;
                }
                db.activeChats.forEach(chat => {
                    const listItem = document.createElement('li');
                    listItem.className = 'chat-list-item';
                    listItem.dataset.profileName = chat.withUserName;
                    listItem.dataset.profileImg = chat.withUserImg;
                    listItem.dataset.otherUserId = chat.otherUserId;
                    listItem.innerHTML = `<img src="${chat.withUserImg || 'https://via.placeholder.com/50'}" alt="${chat.withUserName}"><div class="chat-info"><div class="chat-info-header"><span class="chat-name">${chat.withUserName}</span><span class="chat-timestamp">${new Date(chat.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span></div><p class="last-message">${chat.lastMessage}</p></div>`;
                    chatList.appendChild(listItem);
                });
            }
            
            const sendBtn = document.getElementById('send-message-btn');
            const chatInput = document.getElementById('chat-input-field');
            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

            async function fetchAllUsers() {
                if (!currentUserId) return;
                try {
                    const usersSnapshot = await firestore.collection('users').get();
                    const users = [];
                    usersSnapshot.forEach(doc => {
                        if (doc.id !== currentUserId) {
                            users.push(doc.data());
                        }
                    });
                    renderUsersOnHomeScreen(users);
                } catch (error) {
                    console.error("Error fetching users:", error);
                }
            }
            
            // MODIFIED: renderUsersOnHomeScreen with new cost display
            function renderUsersOnHomeScreen(users) {
                const profileGrid = document.querySelector('.profile-grid');
                profileGrid.innerHTML = '';
                users.forEach(user => {
                    const profileCard = document.createElement('div');
                    profileCard.className = 'profile-card';
                    if (user.isOnline === false) {
                        profileCard.classList.add('offline');
                    }
                    profileCard.dataset.profileUid = user.uid;

                    profileCard.innerHTML = `
                        <img src="${user.profileImg}" alt="Profile" class="profile-card-img">
                        <div class="online-dot"></div>
                        <div class="profile-card-overlay">
                            <div class="profile-card-header">
                                <span class="profile-name">${user.name} ‚Ä¢ ${user.age} Y</span>
                                <div class="rating">
                                    <svg viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"></path></svg>
                                    <span>4.8</span>
                                </div>
                            </div>
                            <div class="profile-card-tags">
                                <span>Hindi</span> ‚Ä¢ <span>Friendly</span>
                            </div>
                            <div class="profile-card-footer">
                                <span class="rate">Chat: ${COST_CHAT_PER_MIN}ü•à | Voice: ${COST_VOICE_PER_MIN}ü•à | Video: ${COST_VIDEO_PER_MIN}ü•á (/min)</span>
                                <div class="card-actions">
                                    <button class="card-action-btn chat-btn" data-profile-uid="${user.uid}" data-profile-name="${user.name}" data-profile-img="${user.profileImg}">
                                        <svg viewBox="0 0 24 24"><path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2M20 16H5.2L4 17.2V4H20V16Z"></path></svg>
                                    </button>
                                    <button class="card-action-btn voice-btn">
                                        <svg viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"></path></svg>
                                    </button>
                                    <button class="card-action-btn video-btn">
                                       <svg viewBox="0 0 24 24"><path d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"></path></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    profileGrid.appendChild(profileCard);
                });
            }
            
            // --- WEBRTC IMPLEMENTATION ---
            async function setupLocalMedia(isVideo) {
                try {
                    const constraints = { audio: true, video: isVideo ? { facingMode: currentFacingMode } : false };
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    localVideo.srcObject = stream;
                    localStream = stream;
                    localVideo.style.display = isVideo ? 'block' : 'none';
                    return stream;
                } catch (error) {
                    console.error('Error accessing media devices.', error);
                    alert("Could not access camera/microphone. Please check permissions.");
                    return null;
                }
            }
            
            async function switchCamera() {
                if (!localStream || !peerConnection || localStream.getVideoTracks().length === 0) return;
                currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                try {
                    const newVideoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
                    const newVideoTrack = newVideoStream.getVideoTracks()[0];
                    const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) await sender.replaceTrack(newVideoTrack);
                    localStream.getVideoTracks().forEach(track => track.stop());
                    const audioTrack = localStream.getAudioTracks()[0];
                    localStream = new MediaStream([newVideoTrack, audioTrack]);
                    localVideo.srcObject = localStream;
                } catch (error) {
                    console.error("Error switching camera:", error);
                    currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user'; // Revert on error
                    alert("Could not switch camera.");
                }
            }
            switchCameraBtn.addEventListener('click', switchCamera);
            
            // MODIFIED: startCall checks and uses the correct coin type
            async function startCall(receiverUid, isVideo) {
                const coinType = isVideo ? 'gold' : 'silver';
                const costPerMinute = isVideo ? COST_VIDEO_PER_MIN : COST_VOICE_PER_MIN;
                const currentBalance = isVideo ? currentUserGoldCoins : currentUserSilverCoins;

                if (currentBalance < costPerMinute) {
                    alert(`You need at least ${costPerMinute} ${coinType} coins for this call. Please recharge.`);
                    showPage('recharge-screen');
                    generateRechargePlans();
                    return;
                }
                
                await setupLocalMedia(isVideo);
                if(!localStream) return;
                
                try {
                     const userRef = firestore.collection('users').doc(currentUserId);
                     const fieldToUpdate = coinType === 'gold' ? 'goldCoins' : 'silverCoins';
                     await userRef.update({
                         [fieldToUpdate]: firebase.firestore.FieldValue.increment(-costPerMinute)
                     });
                } catch(e) {
                    console.error("Initial call deduction failed:", e);
                    alert("A billing error occurred. Call could not be started.");
                    if (localStream) localStream.getTracks().forEach(track => track.stop());
                    return;
                }
                
                startCallTimer(costPerMinute, coinType);
                showPage('call-screen');

                callRef = database.ref('calls').push();
                currentCallId = callRef.key;
                peerConnection = new RTCPeerConnection(servers);

                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                peerConnection.ontrack = event => remoteVideo.srcObject = event.streams[0];
                peerConnection.onicecandidate = event => {
                    if (event.candidate) callRef.child('offerCandidates').push(event.candidate.toJSON());
                };

                const offerDescription = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offerDescription);

                const callerDoc = await firestore.collection('users').doc(currentUserId).get();
                const callerData = callerDoc.data();

                await callRef.set({
                    offer: { sdp: offerDescription.sdp, type: offerDescription.type },
                    callerId: currentUserId,
                    callerName: callerData.name || "Unknown",
                    callerImg: callerData.profileImg || "",
                    receiverId: receiverUid,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: isVideo ? 'video' : 'voice'
                });

                callRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.answer && !peerConnection.currentRemoteDescription) {
                        peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                });

                callRef.child('answerCandidates').on('child_added', (snapshot) => {
                    peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val()));
                });
            }

            function listenForIncomingCalls(uid) {
                database.ref('calls').orderByChild('receiverId').equalTo(uid).limitToLast(1).on('child_added', (snapshot) => {
                    const data = snapshot.val();
                    if (data && !data.answer && (Date.now() - data.timestamp < 60000)) { 
                        currentCallId = snapshot.key;
                        incomingCallerName.textContent = data.callerName;
                        incomingCallerImg.src = data.callerImg || "https://via.placeholder.com/100";
                        incomingCallModal.classList.add('active');
                    }
                });
            }

            acceptCallBtn.addEventListener('click', async () => {
                incomingCallModal.classList.remove('active');
                
                callRef = database.ref(`calls/${currentCallId}`);
                const callSnapshot = await callRef.get();
                const callData = callSnapshot.val();
                
                const isVideo = callData.type === 'video';
                const coinType = isVideo ? 'gold' : 'silver';
                const costPerMinute = isVideo ? COST_VIDEO_PER_MIN : COST_VOICE_PER_MIN;

                // Receiver also needs coins to accept the call
                if ((isVideo && currentUserGoldCoins < costPerMinute) || (!isVideo && currentUserSilverCoins < costPerMinute)) {
                    alert(`You need at least ${costPerMinute} ${coinType} coins to accept this call. Please recharge.`);
                    rejectCallBtn.click(); // Automatically reject if not enough coins
                    return;
                }

                await setupLocalMedia(isVideo);
                if(!localStream) return;
                
                showPage('call-screen');
                peerConnection = new RTCPeerConnection(servers);
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                peerConnection.ontrack = event => remoteVideo.srcObject = event.streams[0];
                peerConnection.onicecandidate = event => {
                    if (event.candidate) callRef.child('answerCandidates').push(event.candidate.toJSON());
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(callData.offer));
                const answerDescription = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answerDescription);

                await callRef.update({ answer: { type: answerDescription.type, sdp: answerDescription.sdp } });
                callRef.child('offerCandidates').on('child_added', (snapshot) => {
                    peerConnection.addIceCandidate(new RTCIceCandidate(snapshot.val()));
                });
            });

            rejectCallBtn.addEventListener('click', () => {
                incomingCallModal.classList.remove('active');
            });

            hangupBtn.addEventListener('click', endCall);

            function endCall() {
                stopCallTimer();
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                localVideo.srcObject = null;
                remoteVideo.srcObject = null;
                showPage('home-screen');
                if (callRef) callRef.off();
                currentCallId = null;
                currentFacingMode = 'user';
            }
        });
    </script>
</body>
</html>
